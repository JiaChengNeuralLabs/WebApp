{% extends 'students/base.html' %}

{% block title %}Factura {{ tax_invoice.invoice_number }} - Autoescuela Carrasco{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-12">
        <a href="{% url 'tax_invoice_list' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Volver a Facturas
        </a>
        <a href="{% url 'tax_invoice_pdf' tax_invoice.pk %}" class="btn btn-primary">
            <i class="bi bi-file-earmark-pdf"></i> Descargar PDF
        </a>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-receipt"></i> Factura Trimestral {{ tax_invoice.invoice_number }}
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h5>Datos del Cliente</h5>
                        <p><strong>Nombre:</strong> {{ tax_invoice.client_name }}</p>
                        <p><strong>DNI:</strong> {{ tax_invoice.client_dni }}</p>
                        {% if tax_invoice.client_street %}
                        <p><strong>Direccion:</strong> {{ tax_invoice.client_street }}</p>
                        {% endif %}
                        {% if tax_invoice.client_postal_code %}
                        <p><strong>CP:</strong> {{ tax_invoice.client_postal_code }}</p>
                        {% endif %}
                        {% if tax_invoice.client_municipality %}
                        <p><strong>Municipio:</strong> {{ tax_invoice.client_municipality }}{% if tax_invoice.client_province %}, {{ tax_invoice.client_province }}{% endif %}</p>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <h5>Datos de la Factura</h5>
                        <p><strong>Numero:</strong> {{ tax_invoice.invoice_number }}</p>
                        <p><strong>Fecha:</strong> {{ tax_invoice.fecha|date:"d/m/Y" }}</p>
                        <p><strong>Trimestre:</strong> T{{ tax_invoice.quarter }} - {{ tax_invoice.year }}</p>
                        <p><strong>Curso:</strong> <span class="badge bg-secondary">{{ tax_invoice.curso }}</span></p>
                    </div>
                </div>

                <hr>

                <h5>Tasas DGT Aplicadas</h5>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <ul class="list-unstyled">
                            <li>
                                {% if tax_invoice.has_tasa_basica %}
                                <i class="bi bi-check-circle-fill text-success"></i>
                                {% else %}
                                <i class="bi bi-x-circle text-muted"></i>
                                {% endif %}
                                Tasa Basica (94.05 euros)
                            </li>
                            <li>
                                {% if tax_invoice.has_tasa_a %}
                                <i class="bi bi-check-circle-fill text-success"></i>
                                {% else %}
                                <i class="bi bi-x-circle text-muted"></i>
                                {% endif %}
                                Tasa A - Motocicletas (28.87 euros)
                            </li>
                            <li>
                                {% if tax_invoice.has_traslado %}
                                <i class="bi bi-check-circle-fill text-success"></i>
                                {% else %}
                                <i class="bi bi-x-circle text-muted"></i>
                                {% endif %}
                                Traslado expediente (8.67 euros)
                            </li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        {% if tax_invoice.renovaciones_count > 0 %}
                        <p><strong>Renovaciones:</strong> {{ tax_invoice.renovaciones_count }} x 94.05 euros</p>
                        {% endif %}
                    </div>
                </div>

                <hr>

                <h5>Desglose de Importes</h5>
                <table class="table table-bordered">
                    <tbody>
                        <tr>
                            <td>Base Imponible</td>
                            <td class="text-end">{{ tax_invoice.base_imponible }} &euro;</td>
                        </tr>
                        <tr>
                            <td>IVA ({% if tax_invoice.iva_amount > 0 %}21%{% else %}0%{% endif %})</td>
                            <td class="text-end">{{ tax_invoice.iva_amount }} &euro;</td>
                        </tr>
                        <tr>
                            <td>Tasas DGT (Exento)</td>
                            <td class="text-end">{{ tax_invoice.tasas_amount }} &euro;</td>
                        </tr>
                        <tr class="table-success">
                            <td><strong>TOTAL</strong></td>
                            <td class="text-end"><strong>{{ tax_invoice.total }} &euro;</strong></td>
                        </tr>
                    </tbody>
                </table>

                {% if tax_invoice.payments.exists %}
                <hr>
                <h5>Pagos Vinculados</h5>
                <ul class="list-group">
                    {% for payment in tax_invoice.payments.all %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        {{ payment.date_paid|date:"d/m/Y" }} - {{ payment.get_payment_method_display }}
                        <span class="badge bg-success">{{ payment.amount }} &euro;</span>
                    </li>
                    {% endfor %}
                </ul>
                {% endif %}

                {% if tax_invoice.notes %}
                <hr>
                <h5>Notas</h5>
                <p>{{ tax_invoice.notes }}</p>
                {% endif %}
            </div>
            <div class="card-footer text-muted">
                <small>
                    Creado el {{ tax_invoice.created_at|date:"d/m/Y H:i" }}
                    {% if tax_invoice.created_by %} por {{ tax_invoice.created_by.username }}{% endif %}
                </small>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-person"></i> Alumno
            </div>
            <div class="card-body">
                <h5>{{ tax_invoice.student.first_name }} {{ tax_invoice.student.last_name }}</h5>
                <p class="text-muted">{{ tax_invoice.student.dni }}</p>
                <a href="{% url 'student_detail' tax_invoice.student.pk %}" class="btn btn-outline-primary btn-sm">
                    <i class="bi bi-person"></i> Ver Perfil del Alumno
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}
